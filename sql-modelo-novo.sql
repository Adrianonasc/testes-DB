/**
* Empresa - Banco de dados de origem (esquema antigo)
* Empresa2 - Banco de dados de destino (esquema novo)
**/


CREATE TABLE RESPONSAVEL
(
  RESPONSAVEL_ID            CHAR(36) NOT NULL,
  VIGENCIA_ID               CHAR(36) NOT NULL,
  TIPO                      INT      NOT NULL,
  DATA_VIGENCIA_RESPONSAVEL DATETIME NOT NULL,
  NOME                      TEXT     NULL    ,
  PRIMARY KEY (RESPONSAVEL_ID)
);

CREATE TABLE TELEFONE_RESP
(
  TELEFONE_ID            CHAR(36) NOT NULL,
  RESPONSAVEL_ID         CHAR(36) NOT NULL,
  DATA_VIGENCIA_TELEFONE DATETIME NOT NULL,
  TELEFONE               TEXT     NOT NULL,
  PRIMARY KEY (TELEFONE_ID)
);

CREATE TABLE VIGENCIA
(
  VIGENCIA_ID   CHAR(36) NOT NULL,
  CODIGO        INT      NOT NULL,
  DATA_VIGENCIA DATETIME NOT NULL,
  CNPJ          TEXT     NOT NULL,
  NOME_EMPRESA  TEXT     NOT NULL,
  PRIMARY KEY (VIGENCIA_ID)
);

ALTER TABLE RESPONSAVEL
  ADD CONSTRAINT FK_VIGENCIA_TO_RESPONSAVEL
    FOREIGN KEY (VIGENCIA_ID)
    REFERENCES VIGENCIA (VIGENCIA_ID);

ALTER TABLE TELEFONE_RESP
  ADD CONSTRAINT FK_RESPONSAVEL_TO_TELEFONE_RESP
    FOREIGN KEY (RESPONSAVEL_ID)
    REFERENCES RESPONSAVEL (RESPONSAVEL_ID);

ALTER TABLE RESPONSAVEL
  ADD CONSTRAINT FK_VIGENCIA_TO_RESPONSAVEL
    FOREIGN KEY (CODIGO, DATA_VIGENCIA)
    REFERENCES VIGENCIA (CODIGO, DATA_VIGENCIA);

ALTER TABLE TELEFONE_RESP
  ADD CONSTRAINT FK_RESPONSAVEL_TO_TELEFONE_RESP
    FOREIGN KEY (TIPO, DATA_VIGENCIA_RESPONSAVEL, CODIGO, DATA_VIGENCIA)
    REFERENCES RESPONSAVEL (TIPO, DATA_VIGENCIA_RESPONSAVEL, CODIGO, DATA_VIGENCIA);

INSERT INTO VIGENCIA(VIGENCIA_ID, CODIGO, DATA_VIGENCIA, CNPJ, NOME_EMPRESA)VALUES('717a869d-e0e3-11ef-b4b1-aed27ff04793', 1, '2025-01-01 19:33:53', '01297396000143', 'Gael e Sara MEI');
INSERT INTO VIGENCIA(VIGENCIA_ID, CODIGO, DATA_VIGENCIA, CNPJ, NOME_EMPRESA)VALUES('717a86da-e0e3-11ef-b4b1-aed27ff04793', 1, '2025-01-10 19:34:00', '01297396000143', 'Gael Ltda');
INSERT INTO VIGENCIA(VIGENCIA_ID, CODIGO, DATA_VIGENCIA, CNPJ, NOME_EMPRESA)VALUES('717a86e8-e0e3-11ef-b4b1-aed27ff04793', 1, '2025-01-20 19:34:07', '01297396000143', 'Gael e Sara Casa Diurna Ltda');
INSERT INTO VIGENCIA(VIGENCIA_ID, CODIGO, DATA_VIGENCIA, CNPJ, NOME_EMPRESA)VALUES('717a86f4-e0e3-11ef-b4b1-aed27ff04793', 1, '2025-02-01 19:34:10', '01297396000143', 'Gael e Sara Ltda');
INSERT INTO VIGENCIA(VIGENCIA_ID, CODIGO, DATA_VIGENCIA, CNPJ, NOME_EMPRESA)VALUES('717a8701-e0e3-11ef-b4b1-aed27ff04793', 2, '2025-02-01 19:34:12', '94419006000141', 'Benjamin e Fátima Assessoria Jurídica Ltda');
INSERT INTO VIGENCIA(VIGENCIA_ID, CODIGO, DATA_VIGENCIA, CNPJ, NOME_EMPRESA)VALUES('717a870c-e0e3-11ef-b4b1-aed27ff04793', 3, '2025-02-01 19:34:13', '79530353000153', 'Marcos Vinicius e Maria Restaurante Ltda');
INSERT INTO VIGENCIA(VIGENCIA_ID, CODIGO, DATA_VIGENCIA, CNPJ, NOME_EMPRESA)VALUES('717a8717-e0e3-11ef-b4b1-aed27ff04793', 4, '2025-02-01 19:34:24', '90422951000141', 'Leandro e Isabel Telecomunicações Ltda');


INSERT INTO RESPONSAVEL(VIGENCIA_ID, RESPONSAVEL_ID, TIPO, DATA_VIGENCIA_RESPONSAVEL, NOME)VALUES('a98f9f55-e0e4-11ef-b4b1-aed27ff04793', 'a98f9f5c-e0e4-11ef-b4b1-aed27ff04793', 1, '2025-01-01 19:33:53', 'Bianca Tatiane Débora Cavalcanti');
INSERT INTO RESPONSAVEL(VIGENCIA_ID, RESPONSAVEL_ID, TIPO, DATA_VIGENCIA_RESPONSAVEL, NOME)VALUES('a98f9f8b-e0e4-11ef-b4b1-aed27ff04793', 'a98f9f8c-e0e4-11ef-b4b1-aed27ff04793', 2, '2025-01-01 19:33:53', 'Ryan Ryan Drumond');
INSERT INTO RESPONSAVEL(VIGENCIA_ID, RESPONSAVEL_ID, TIPO, DATA_VIGENCIA_RESPONSAVEL, NOME)VALUES('a98f9f9b-e0e4-11ef-b4b1-aed27ff04793', 'a98f9f9d-e0e4-11ef-b4b1-aed27ff04793', 3, '2025-01-01 19:33:53', 'Jaqueline Stefany Bruna Pires');
INSERT INTO RESPONSAVEL(VIGENCIA_ID, RESPONSAVEL_ID, TIPO, DATA_VIGENCIA_RESPONSAVEL, NOME)VALUES('a98f9fbb-e0e4-11ef-b4b1-aed27ff04793', 'a98f9fbc-e0e4-11ef-b4b1-aed27ff04793', 1, '2025-01-10 19:34:00', 'Bianca Tatiane Débora Cavalcanti');
INSERT INTO RESPONSAVEL(VIGENCIA_ID, RESPONSAVEL_ID, TIPO, DATA_VIGENCIA_RESPONSAVEL, NOME)VALUES('a98f9fc7-e0e4-11ef-b4b1-aed27ff04793', 'a98f9fc8-e0e4-11ef-b4b1-aed27ff04793', 2, '2025-01-10 19:34:00', 'Ryan Ryan Drumond');
INSERT INTO RESPONSAVEL(VIGENCIA_ID, RESPONSAVEL_ID, TIPO, DATA_VIGENCIA_RESPONSAVEL, NOME)VALUES('a98f9fd4-e0e4-11ef-b4b1-aed27ff04793', 'a98f9fd5-e0e4-11ef-b4b1-aed27ff04793', 3, '2025-01-10 19:34:00', 'Jaqueline Stefany Bruna Pires');
INSERT INTO RESPONSAVEL(VIGENCIA_ID, RESPONSAVEL_ID, TIPO, DATA_VIGENCIA_RESPONSAVEL, NOME)VALUES('a98f9fea-e0e4-11ef-b4b1-aed27ff04793', 'a98f9feb-e0e4-11ef-b4b1-aed27ff04793', 1, '2025-01-20 19:34:07', 'Bianca Tatiane Débora Cavalcanti');
INSERT INTO RESPONSAVEL(VIGENCIA_ID, RESPONSAVEL_ID, TIPO, DATA_VIGENCIA_RESPONSAVEL, NOME)VALUES('a98f9ff6-e0e4-11ef-b4b1-aed27ff04793', 'a98f9ff7-e0e4-11ef-b4b1-aed27ff04793', 2, '2025-01-20 19:34:07', 'Ryan Ryan Drumond');
INSERT INTO RESPONSAVEL(VIGENCIA_ID, RESPONSAVEL_ID, TIPO, DATA_VIGENCIA_RESPONSAVEL, NOME)VALUES('a98fa003-e0e4-11ef-b4b1-aed27ff04793', 'a98fa004-e0e4-11ef-b4b1-aed27ff04793', 3, '2025-01-20 19:34:07', 'Jaqueline Stefany Bruna Pires');
INSERT INTO RESPONSAVEL(VIGENCIA_ID, RESPONSAVEL_ID, TIPO, DATA_VIGENCIA_RESPONSAVEL, NOME)VALUES('a98fa01b-e0e4-11ef-b4b1-aed27ff04793', 'a98fa01c-e0e4-11ef-b4b1-aed27ff04793', 1, '2025-02-01 19:34:10', 'Bianca Tatiane Débora Cavalcanti');
INSERT INTO RESPONSAVEL(VIGENCIA_ID, RESPONSAVEL_ID, TIPO, DATA_VIGENCIA_RESPONSAVEL, NOME)VALUES('a98fa028-e0e4-11ef-b4b1-aed27ff04793', 'a98fa029-e0e4-11ef-b4b1-aed27ff04793', 2, '2025-02-01 19:34:10', 'Ryan Ryan Drumond');
INSERT INTO RESPONSAVEL(VIGENCIA_ID, RESPONSAVEL_ID, TIPO, DATA_VIGENCIA_RESPONSAVEL, NOME)VALUES('a98fa034-e0e4-11ef-b4b1-aed27ff04793', 'a98fa035-e0e4-11ef-b4b1-aed27ff04793', 3, '2025-02-01 19:34:10', 'Jaqueline Stefany Bruna Pires');
INSERT INTO RESPONSAVEL(VIGENCIA_ID, RESPONSAVEL_ID, TIPO, DATA_VIGENCIA_RESPONSAVEL, NOME)VALUES('a98fa04a-e0e4-11ef-b4b1-aed27ff04793', 'a98fa04b-e0e4-11ef-b4b1-aed27ff04793', 1, '2025-02-01 19:34:12', 'Maria Sueli Gomes');
INSERT INTO RESPONSAVEL(VIGENCIA_ID, RESPONSAVEL_ID, TIPO, DATA_VIGENCIA_RESPONSAVEL, NOME)VALUES('a98fa05f-e0e4-11ef-b4b1-aed27ff04793', 'a98fa060-e0e4-11ef-b4b1-aed27ff04793', 1, '2025-02-01 19:34:13', 'Maria Sueli Gomes');
INSERT INTO RESPONSAVEL(VIGENCIA_ID, RESPONSAVEL_ID, TIPO, DATA_VIGENCIA_RESPONSAVEL, NOME)VALUES('a98fa074-e0e4-11ef-b4b1-aed27ff04793', 'a98fa075-e0e4-11ef-b4b1-aed27ff04793', 1, '2025-02-01 19:34:24', 'Maria Sueli Gomes');


INSERT
	INTO
	RESPONSAVEL(VIGENCIA_ID,
	RESPONSAVEL_ID,
	TIPO,
	DATA_VIGENCIA_RESPONSAVEL,
	NOME)
SELECT
	(
	SELECT
		VIGENCIA_ID
	FROM
		VIGENCIA
	WHERE
		CODIGO = t.CODIGO
		AND DATA_VIGENCIA = t.DATA_VIGENCIA) AS VIGENCIA_ID,
	UUID() RESPONSAVEL_ID,
	t.TIPO,
	t.DATA_VIGENCIA_RESPONSAVEL,
	t.NOME
FROM
	Empresa2.VIGENCIA r
INNER JOIN Empresa.RESPONSAVEL t ON
	r.CODIGO = t.CODIGO
	AND r.DATA_VIGENCIA = t.DATA_VIGENCIA
where
	NOT EXISTS (SELECT R2.RESPONSAVEL_ID FROM Empresa2.RESPONSAVEL R2 
			WHERE r.VIGENCIA_ID = VIGENCIA_ID AND R2.TIPO = TIPO);


INSERT INTO TELEFONE_RESP(RESPONSAVEL_ID, TELEFONE_ID, DATA_VIGENCIA_TELEFONE, TELEFONE)
select DISTINCT RESPONSAVEL_ID, UUID() TELEFONE_ID , DATA_VIGENCIA_TELEFONE, TELEFONE from Empresa.TELEFONE_RESP t
	INNER JOIN Empresa2.RESPONSAVEL r ON r.VIGENCIA_ID = (select VIGENCIA_ID from Empresa2.VIGENCIA v where t.CODIGO = v.CODIGO AND t.DATA_VIGENCIA = v.DATA_VIGENCIA ) and t.TIPO = r.TIPO    
	where NOT EXISTS (SELECT T2.RESPONSAVEL_ID FROM Empresa2.TELEFONE_RESP T2 
			WHERE r.RESPONSAVEL_ID = T2.RESPONSAVEL_ID AND T2.DATA_VIGENCIA_TELEFONE = t.DATA_VIGENCIA_TELEFONE);
